<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>上传视频</title>
    <link href="lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/x100speed.css" rel="stylesheet">
  </head>

  <body>
    <div class="container">
    <nav class="navbar navbar-default navbar-fixed-top" style="border-top:2px solid #f06923;">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" style="color: #333; text-shadow: 0 1px 3px rgba(0,0,0,.5);" href="/"><em>x100Speed-Transcode</em></a>
        </div>
        <div id="navbar" class="navbar-collapse navbar-right">
          <a class="navbar-brand" href="upload.html" style="color: #f06923;font-size: 16px">上传视频</a>
          <a class="navbar-brand" href="play.html" style="font-size: 16px">播放视频</a>
        </div>
      </div>
    </nav>
    </div>

    <div class="container" style="margin-top: 200px;">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
        <h1>上传视频<h1>
        <form class="form-inline" id="upload-form" action="" method="post" enctype="multipart/form-data">
          <input type="file" class="form-control input-lg" name="upload" id="upload" />
          <input type="submit" id="upload" class="btn btn-default btn-lg" value="上传" /> 
	      </form>
		    <progress value="0" min="0" max="100" id="uploadprogress"></progress>
        </div>
      </div>
		</div>

		<div style="display:none"><img class="progress_img img-responsive" style="float:left;max-width:50px" src=""></div>
  </body>
</html>

<script src="lib/jquery-1.11.3.min.js"></script>
<script type="text/javascript">
	function new_snap() {
		$.get("img.txt", function(data){
				console.log(data);
				if(data!="") {
				  if (img_count >= 14) {
					$(".progress_img:first").remove();
				  }
				  var new_img_node = $(".progress_img:first").clone();
				  $(new_img_node).attr("src", data);
				  $(new_img_node).hide();
				  $(".myimg").append($(new_img_node));
				  $(new_img_node).fadeIn("slow");
				  img_count += 1;
				}
			});
	}
	
	function upload_start() {
		img_interval_id = setInterval(new_snap, 1000);
		uploadfile();
	}

	function update_progress(e) {
		if(e.lengthComputable) {
			var max = e.total;
			var current = e.loaded;

			var percent = (current / max * 100 | 0);
			if (percent <= 99) {
				$('#uploadprogress').attr("value", percent);
			}
		} 
	}

	function success_upload(e) {
		$('#uploadprogress').attr("value", 100);
		clearInterval(img_interval_id);
		console.log("uplod xxxxx success");
	}

	function uploadfile() {
		var formdata = new FormData();		
		formdata.append('upload', $('#upload')[0].files[0]);
		$.ajax({
			type: "POST",		
			url : "http://www.speed.com/action.php",
			data: formdata,
			xhr: function() {
				var myxhr = $.ajaxSettings.xhr();
				if(myxhr.upload){
					myxhr.upload.addEventListener('progress',update_progress, false);
					myxhr.upload.addEventListener('load', success_upload, false);
				}
				return myxhr;
			},
			cache: false,
			contentType: false,
			processData: false,
			success: function(data) {
				console.log("upload success");	
			},
			error: function(data) {
				console.log("upload error");			
			}
		});

		console.log("uploadfile");			
	}

	$("form").submit( function () {
		upload_start();
		return false;
	});

	var img_count = 0;
	var img_interval_id;
	$(document).ready(function(){ 
	});
</script>
