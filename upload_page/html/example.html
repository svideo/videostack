<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    
    <title>文件上传</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/cover.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="html5shiv.min.js"></script>
    <script src="respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="site-wrapper">
      <div class="site-wrapper-inner">
        <div class="cover-container">
          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand"><a href="/">www.speed.com</a></h3>
            </div>
          </div>

          <div class="inner cover">
			  <h1 class="cover-heading">文件上传<h1>
            <br/>
			<form class="form-inline" id="upload-form" action="" method="post" enctype="multipart/form-data">
              <input type="file" class="form-control input-lg" name="upload" id="upload" placeholder="" autofocus>
              <input type="submit" id="upload" class="btn btn-default btn-lg" value="上传" /> 
	        </form>
		    <progress value="0" min="0" max="100" id="uploadprogress"></progress>
		  </div>

		  <div class="row">
			  <div class="col-xs-12 myimg" >
			  </div>
		  </div>

          <div class="mastfoot">
            <div class="inner">
            </div>
          </div>

		  <div style="display:none">
		    <img class="progress_img img-responsive" style="float:left;max-width:80px;position:relative" src="">
		  </div>

		  <div style="display:none" id="show_play_link">
			  <div class="row">
				  <div class="col-offset-xs-4 col-xs-8">
					播放地址: <a id="m3u8_url" href="#"></a>
				  </div>
			  </div> <!-- row -->
		  </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
	function upload_start() {
		img_interval_id = setInterval(new_snap, 1500);
		player_m3u8_interval_id = setInterval(get_m3u8_content, 10000); 
		get_video_id();
	}

	function new_snap() {
		var snap_url_api = "http://10.221.193.196:5000/interface/video_uuid_new_image_get?uuid=" + video_id
		$.get(snap_url_api, function(data){
				console.log(data);
				if(data!="" && data.image_url != last_snap) {
				  last_snap = data.image_url;
				  if (img_count >= 8) {
					$(".progress_img:first").remove();
				  }
				  var new_img_node = $(".progress_img:first").clone();
				  $(new_img_node).attr("src", data.image_url);
				  $(new_img_node).hide();
				  $(".myimg").append($(new_img_node));
				  //$(new_img_node).fadeIn("slow");
				  $(new_img_node).animate({right: '+100px', opacity: 'show'}, "slow");
				  img_count += 1;
				}
			}, "json");
	}
	
	function update_progress(e) {
		if(e.lengthComputable) {
			var max = e.total;
			var current = e.loaded;

			var percent = (current / max * 100 | 0);
			if (percent < 100) {
				$('#uploadprogress').attr("value", percent);
			}
		} 
	}

	function get_video_id() {
		$.ajax({
			url: 'http://10.221.193.196:5000/interface/video_uuid_get',
			type: "GET",
			dataType: "json",
			success: function (data) {
				video_id = data.uuid
				console.log(data.uuid);
				upload_file();
			}
		});
	}

	function get_m3u8_content() {
		var m3u8_url = m3u8_hostname + '/interface/' + video_id + '.m3u8';
		var player_url = player_hostname + '/' + 'player.html?m3u8_url=' + m3u8_url
		$.ajax({
			url: '',
			type: "GET",
			success: function (data) {
				if (data != "") {
					$('#m3u8_url').attr("href", player_url);
					$('#m3u8_url').html(m3u8_url);
					$('#show_play_link').show();
					clearInterval(player_m3u8_interval_id);
				}
			}
		});
	}

	function success_upload(e) {
		$('#uploadprogress').attr("value", 100);
		clearInterval(img_interval_id);
		console.log("uplod xxxxx success");
	}

	function upload_file() {
		var formdata = new FormData();		
		formdata.append('video_id', video_id);
		formdata.append('upload', $('#upload')[0].files[0]);

		$.ajax({
			type: "POST",		
			url : "http://www.speed.com/action.php",
			data: formdata,
			xhr: function() {
				var myxhr = $.ajaxSettings.xhr();
				if(myxhr.upload){
					myxhr.upload.addEventListener('progress',update_progress, false);
					myxhr.upload.addEventListener('load', success_upload, false);
				}
				return myxhr;
			},
			cache: false,
			contentType: false,
			processData: false,
			success: function(data) {
				console.log("upload success");	
			},
			error: function(data) {
				console.log("upload error");			
			}
		});

		console.log("uploadfile");			
	}

	$("form").submit( function () {
		upload_start();
		return false;
	});

	var img_count = 0;
	var img_interval_id;
	var video_id  = undefined;
	var last_snap = undefined; 
	var player_hostname = 'http://10.221.193.196:5000';
	var m3u8_hostname = 'http://10.221.193.196:5000';
	var player_m3u8_interval_id;
	$(document).ready(function(){ 
			});
</script>
