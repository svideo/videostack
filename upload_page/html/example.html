<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    
    <title>文件上传</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/cover.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="html5shiv.min.js"></script>
    <script src="respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="site-wrapper">
      <div class="site-wrapper-inner">
        <div class="cover-container">
          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand"><a href="/">www.speed.com</a></h3>
            </div>
          </div>

          <div class="inner cover">
			  <h1 class="cover-heading">文件上传<h1>
            <br/>
			<form class="form-inline" id="upload-form" action="" method="post" enctype="multipart/form-data">
              <input type="file" class="form-control input-lg" name="upload" id="upload" placeholder="" autofocus>
              <input type="submit" id="upload" class="btn btn-default btn-lg" value="上传" /> 
	        </form>
		    <progress value="0" min="0" max="100" id="uploadprogress"></progress>
		  </div>

		  <div class="row">
			  <div class="col-xs-12 myimg" >
			  </div>
		  </div>

          <div class="mastfoot">
            <div class="inner">
            </div>
          </div>

		  <div style="display:none">
		    <img class="progress_img img-responsive" style="float:left;max-width:50px" src="">
		  </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
	function new_snap() {
		$.get("img.txt", function(data){
				console.log(data);
				if(data!="") {
				  if (img_count >= 14) {
					$(".progress_img:first").remove();
				  }
				  var new_img_node = $(".progress_img:first").clone();
				  $(new_img_node).attr("src", data);
				  $(new_img_node).hide();
				  $(".myimg").append($(new_img_node));
				  $(new_img_node).fadeIn("slow");
				  img_count += 1;
				}
			});
	}
	
	function upload_start() {
		//img_interval_id = setInterval(new_snap, 1000);
		get_channel_id();
	}

	function update_progress(e) {
		if(e.lengthComputable) {
			var max = e.total;
			var current = e.loaded;

			var percent = (current / max * 100 | 0);
			if (percent <= 99) {
				$('#uploadprogress').attr("value", percent);
			}
		} 
	}

	function get_channel_id() {
		$.get("http://10.221.193.196:5000/getvideomaxid", function(data){
				channel_id = data;
				upload_file();
			});
	}

	function success_upload(e) {
		$('#uploadprogress').attr("value", 100);
		clearInterval(img_interval_id);
		console.log("uplod xxxxx success");
	}

	function upload_file() {
		var formdata = new FormData();		
		//if (!channel_id) {
		//	return false;	
		//}
		console.log(channel_id);
		formdata.append('channel_id', channel_id);
		formdata.append('upload', $('#upload')[0].files[0]);

		$.ajax({
			type: "POST",		
			url : "http://www.speed.com/action.php",
			data: formdata,
			xhr: function() {
				var myxhr = $.ajaxSettings.xhr();
				if(myxhr.upload){
					myxhr.upload.addEventListener('progress',update_progress, false);
					myxhr.upload.addEventListener('load', success_upload, false);
				}
				return myxhr;
			},
			cache: false,
			contentType: false,
			processData: false,
			success: function(data) {
				console.log("upload success");	
			},
			error: function(data) {
				console.log("upload error");			
			}
		});

		console.log("uploadfile");			
	}

	$("form").submit( function () {
		upload_start();
		return false;
	});

	var img_count = 0;
	var img_interval_id;
	var channel_id = undefined;
	$(document).ready(function(){ 
			});
</script>
